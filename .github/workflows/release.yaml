# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Release and Cleanup"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *" # 1st of every month at midnight UTC

jobs:
  release:
    name: "Build, Push, and Release"
    runs-on: ubuntu-latest
    permissions:
      contents: write   # To create releases and tags
      packages: write   # To push images to GHCR
    steps:
      - name: "Get Previous Release Tag and Determine Next Tag"
        id: determine-next-tag
        uses: actions/github-script@v7
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          result-encoding: string
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1,
            });
            let previousTag = "0.0.0";
            if (releases.length > 0) {
              previousTag = releases[0].tag_name;
            }
            const [previousMajor, previousMinor, previousPatch] = previousTag.split('.').map(Number);
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            const nextMajorMinor = `${currentYear}.${currentMonth}`;
            let nextPatch;
            if (`${previousMajor}.${previousMinor}` === nextMajorMinor) {
              nextPatch = previousPatch + 1;
            } else {
              nextPatch = 0;
            }
            return `${nextMajorMinor}.${nextPatch}`;

      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Set up QEMU"
        uses: docker/setup-qemu-action@v3

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Login to Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: "Login to GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Build and push Docker image"
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ajaykumar4/gitops-tools:${{ steps.determine-next-tag.outputs.result }}
            ghcr.io/ajaykumar4/gitops-tools:${{ steps.determine-next-tag.outputs.result }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: "Create GitHub Release and Tag"
        uses: ncipollo/release-action@v1
        with:
          generateReleaseNotes: true
          tag: ${{ steps.determine-next-tag.outputs.result }}
          token: "${{ secrets.GITHUB_TOKEN }}"

  cleanup-ghcr:
    name: "Cleanup GHCR Images"
    needs: release
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: "Delete old and untagged container images"
        uses: snok/container-retention-policy@v2
        with:
          package-names: 'gitops-tools'
          delete-untagged: true
          keep-last: 10
          token: ${{ secrets.GITHUB_TOKEN }}