# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Release"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *" # 1st of every month at midnight UTC

jobs:
  release:
    name: "Build, Push, and Release"
    runs-on: ubuntu-latest
    permissions:
      contents: write   # To create releases and tags
      packages: write   # To push images to GHCR
    outputs:
      release_tag: ${{ steps.determine-next-tag.outputs.result }}
    steps:
      - name: "Get Previous Release Tag and Determine Next Tag"
        id: determine-next-tag
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          result-encoding: string
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1,
            });
            let previousTag = "0.0.0";
            if (releases.length > 0) {
              previousTag = releases[0].tag_name;
            }
            const [previousMajor, previousMinor, previousPatch] = previousTag.split('.').map(Number);
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            const nextMajorMinor = `${currentYear}.${currentMonth}`;
            let nextPatch;
            if (`${previousMajor}.${previousMinor}` === nextMajorMinor) {
              nextPatch = previousPatch + 1;
            } else {
              nextPatch = 0;
            }
            return `${nextMajorMinor}.${nextPatch}`;

      - name: "Checkout code"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: "Set up QEMU"
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: "Login to Docker Hub"
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: "Login to GitHub Container Registry"
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Build and push Docker image"
        id: build-and-push
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ajaykumar4/gitops-tools:${{ steps.determine-next-tag.outputs.result }}
            ghcr.io/ajaykumar4/gitops-tools:${{ steps.determine-next-tag.outputs.result }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: "Create GitHub Release and Tag"
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1
        with:
          generateReleaseNotes: true
          tag: ${{ steps.determine-next-tag.outputs.result }}
          token: "${{ secrets.GITHUB_TOKEN }}"

  update-readme:
    name: Update README with new image tag
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write   # To create releases and tags

    steps:
      - name: Checkout repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Set up Git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update image version in README.md
        run: |
          sed -i -E "s|(image: ajaykumar4/gitops-tools:)[0-9a-zA-Z.+-]+|\1${{ needs.release.outputs.release_tag }}|g" README.md

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@28e16e81777b558cc906c8750092100bbb34c5e3 # v7
        with:
          commit_message: "chore: update image tag to ${{ needs.release.outputs.release_tag }}"
          file_pattern: README.md
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}        